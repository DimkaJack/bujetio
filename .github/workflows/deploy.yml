name: Build, test and deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
    build:
        runs-on: debian-latest

        steps:
        - name: Checkout code
          uses: actions/checkout@v4

        - name: Setup PHP
          uses: shivammathur/setup-php@v2
          with:
              php-version: '8.4'
#              extensions: mbstring, bcmath, xml, curl, zip
#              ini-values: post_max_size=256M, upload_max_filesize=256M, memory_limit=512M
#              tools: composer

        - name: Create database
          run: touch .database/database.sqlite

        - name: Copy .env file
          run: cp .env.testing .env

        - name: Install dependencies
          run: composer install

        - name: Run migrations
          run: php artisan migrate

        - name: Test PHPStan
          run: ./vendor/bin/phpstan analyse

        - name: Run PHPUnit tests
          run: ./vendor/bin/phpunit
